---
title: Descriptive Analysis of Body Composition
date: "`r Sys.Date()`"
output: bookdown::pdf_book
---

```{r, echo = F}
library("knitr")
opts_chunk$set(fig.width = 8, fig.height = 8, fig.align = "center")
read_chunk("descriptive.R")
```

```{r setup}
library("tidyverse")
library("reshape2")
library("GGally")
library("qtlcharts")

## cleaner ggplot theme
scale_colour_discrete <- function(...)
  scale_colour_brewer(..., palette="Set2")
scale_fill_discrete <- function(...)
  scale_fill_brewer(..., palette="Set2")

theme_set(theme_bw())
theme_update(
  panel.border = element_rect(size = 0.5),
  panel.grid = element_blank(),
  axis.ticks = element_blank(),
  legend.title = element_text(size = 8),
  legend.text = element_text(size = 6),
  axis.text = element_text(size = 6),
  axis.title = element_text(size = 8),
  strip.background = element_blank(),
  strip.text = element_text(size = 8),
  legend.key = element_blank()
)
```

```{r utils}
#' Make histograms
histo_plot <- function(msurvey) {
  ggplot(msurvey) +
    geom_histogram(
      aes(x = value, fill = as.factor(gender)),
      bins = 60, position = "identity", alpha = 0.6
    ) +
    facet_wrap(~measurement, scales = "free") +
    theme(
      axis.text.y = element_blank()
    )
}

#' Reorder columns according to a clustering
clust_order <- function(x) {
  D <- dist(scale(x))
  rownames(x)[hclust(D)$order]
}
```

```{r read_data}
bc <- readRDS("data/sample_data_bc.rds")
survey <- read_csv("data/WELL_China_1969_7.25.2017.csv")
seqtab <- readRDS("data/seqtab.rds")
taxa <- readRDS("data/taxa.rds")

## getting names to agree across bc and survey -- not sure where aoi came from
bc_survey <- survey %>%
  rename(
    age = age_it,
    gender = gender_it,
    height_dxa = height,
    weight_dxa = weight
  )
bc_cols <- intersect(colnames(bc_survey), tolower(colnames(bc)))
id_map <- setNames(sample_names(bc), bc$id)

## subsetting to the body composition fields
bc_survey <- bc_survey %>%
  select_(.dots = bc_cols) %>%
  mutate(
    id = as.character(id),
    Number = id_map[id]
  ) %>%
  select_(.dots = c("id", "Number", bc_cols)) # reorder columns
```

```{r histograms}
melt_bc_survey <- bc_survey %>%
  gather(measurement, value, -id, -Number, -gender)
histo_plot(melt_bc_survey)

## sorting questions by a clustering
q_levels <- clust_order(t(bc_survey[, -c(1, 2)]))
melt_bc_survey <- melt_bc_survey %>%
  mutate(measurement = factor(measurement, levels = q_levels))
histo_plot(melt_bc_survey)
```

```{r heatmaps}
## scale separately within genders
melt_bc_survey <- melt_bc_survey %>%
  group_by(measurement, gender) %>%
  mutate(scaled_meas = scale(value))

## reorder rows according to clustering also
id_levels <- clust_order(bc_survey[, -c(1:2)])
id_levels <- bc_survey$id[as.numeric(id_levels)]
melt_bc_survey <- melt_bc_survey %>%
  mutate(
    id = factor(id, levels = id_levels)
  )

ggplot(melt_bc_survey) +
  geom_tile(
    aes(x = id, y = measurement, fill = scaled_meas)
  ) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient2() +
  facet_grid(. ~ gender, scale = "free") +
  coord_fixed(ratio = 50) +
  theme(
    axis.text.x = element_blank(),
    legend.position = "top"
  )
```

```{r pairs}
## pairs plot
bc_df <- as.data.frame(bc_survey)
bc_df$gender <- as.factor(bc_survey$gender)
for (i in seq(1, 29, 5)) {
  ggpairs(
    bc_df,
    mapping = aes(color = gender),
    columns = q_levels[i:(i + 5)],
    lower = NULL,
    upper = list(continuous = wrap("points", alpha = 0.3, size=0.1))
  ) %>%
    print()
}
```

```{r correlation_matrix}
bc_mat <- bc_survey %>%
  select(-id, -Number, -gender) %>%
  as.matrix()
iplotCorr(bc_mat, bc_survey$gender)
```
