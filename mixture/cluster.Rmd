---
title: Clustering Counts with Uneven Depths
date: "`r Sys.Date()`"
---

```{r setup}
library("tidyverse")
library("rstan")
library("phyloseq")
library("reshape2")
library("forcats")
set.seed(09212017)

scale_colour_discrete <- function(...)
  scale_colour_brewer(..., palette="Set2")
scale_fill_discrete <- function(...)
  scale_fill_brewer(..., palette="Set2")

theme_set(theme_bw())
theme_update(
  panel.border = element_rect(size = 0.7, fill = "transparent"),
  panel.spacing = unit(0, "cm"),
  panel.grid = element_blank(),
  axis.ticks = element_blank(),
  legend.title = element_text(size = 8),
  legend.text = element_text(size = 6),
  axis.text = element_text(size = 6),
  axis.title = element_text(size = 8),
  strip.background = element_blank(),
  strip.text = element_text(size = 8),
  legend.key = element_blank()
)
```

```{r read_data}
ps <- phyloseq(
  otu_table = readRDS("../data/seqtab.rds"),
  sample_data = readRDS("../data/sample_data_bc.rds"),
  taxa = readRDS("../data/taxa.rds"),
  phylo = readRDS("../data/phylo_tree.rds")
) %>%
  filter_taxa(function(x) { mean(x > 0) > 0.05}, TRUE) ## appear in 5% of samples

taxa <- tax_table(ps) %>%
  as.data.frame %>%
  rownames_to_column("seq")
phylo_order <- phy_tree(ps)$tip
```

## Dirichlet Multinomial Mixtures

Let's test out the dirichelt multinomial mixture model code (on just a subset of
species).

```{r dmm_fit}
K <- 4
stan_data <- list(
  "N" = nsamples(ps),
  "V" = ntaxa(ps),
  "K" = K,
  "x" = get_taxa(ps),
  "alpha" = rep(10, K),
  "gamma" = rep(1e-2, ntaxa(ps))
)

m <- stan_model("dirichlet_multinomial.stan")
dm_fit <- vb(m, stan_data, adapt_engaged = FALSE, eta = 0.1)
dm_res <- extract(dm_fit)
rm(dm_fit)
```

We can study the output -- this method doesn't actually give cluster
assignments, but it gives cluster compositions, from which we can usually guess
the cluster assignments.

```{r dmm_inspect}
colMeans(dm_res$theta) ## how common different clusters are

#' Centered Log Transform
#'
#' Log transform probabilities for each species and cluster at a time.
centered_log <- function(x) {
  for (i in seq_len(nrow(x))) {
    for (k in seq_len(ncol(x))) {
      x[i, k, ] <- log(x[i, k, ])
      x[i, k, ] <- x[i, k, ] - mean(x[i, k, ])
    }
  }
  x
}

p_df <- centered_log(dm_res$p) %>%
  melt(
    varnames = c("iter", "k", "v"),
    value.name = "p"
  )
p_df$seq <- factor(
  taxa_names(ps)[p_df$v],
  levels = phylo_order
)

## include sequence map in tax table
p_df <- p_df %>%
  left_join(taxa %>% select(seq, Family)) %>%
  mutate(family = fct_lump(Family, 7))

ggplot(p_df) +
  geom_boxplot(
    aes(x = seq, y = p, fill = family, col = family),
    outlier.size = 0.2
  ) +
  facet_grid(k ~ .) +
  labs(y = "clog(p)") +
  theme(
    axis.text.x = element_blank(),
    legend.position = "bottom"
  )
```

So it looks like the fourth cluster has more prevotella. The others can be
summarized based on a few species, but it doesn't really seem consistent across
the whole family.

## LDA

LDA also conditions on the total counts in each sample, so also lets us model
variation in sequencing depth. The main difference between this and the
Dirichlet Multinomial mixture model is that here each sample is allowed to have
partial memberships across clusters (rather than being fixed to any single one).
Practically, the big advantage is that we directly get (partial) cluster
assignments, rather than having to guess them from the fitted clustfers.

```{r lda_fit}
m <- stan_model("lda_counts.stan")
lda_fit <- vb(m, stan_data, adapt_engaged = FALSE, eta = 0.1)
lda_res <- extract(lda_fit)
rm(lda_fit)
```

We can now inspect the actual partial cluster assignments and cluster
compositions. First let's study cluster assignments.
```{r}
theta_hat <- apply(lda_res$theta, c(2, 3), mean) %>%
  melt(
    varnames = c("i", "k"),
    value.name = "theta"
  )

sample_order <- hclust(dist(theta_hat))$order
theta_hat <- theta_hat %>%
  mutate(
    i = factor(i, levels = sample_order)
  )

ggplot(theta_hat) +
  geom_tile(
    aes(x = i, y = k, fill = theta)
  ) +
  scale_fill_gradient2(low = "white", high = "black") +
  theme(axis.text.x = element_blank())

## compare with some sample data
theta_supp <- theta_hat %>%
  left_join(samples)

ggplot(theta_supp) +
  geom_histogram(
    aes(x = theta, fill = k)
  ) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(gender ~ k, scale = "free")

ggplot(theta_supp) +
  geom_smooth(
    aes(x = theta, y = aoi, col = k),
    alpha = 0.1
  ) +
  geom_point(
    aes(x = theta, y = aoi, col = k),
    alpha = 0.6
  )

ggplot(theta_supp) +
  geom_smooth(
    aes(x = theta, y = Android_FM / Gynoid_FM, col = k),
    alpha = 0.1
  ) +
  geom_point(
    aes(x = theta, y = Android_FM / Gynoid_FM, col = k),
    alpha = 0.6
  ) +
  scale_x_sqrt()
```

```{r beta_hats}
## Now characterizing the topics
beta_hat <- centered_log(lda_res$beta) %>%
  melt(
    varnames = c("iter", "k", "v"),
    value.name = "beta"
  ) %>%
  mutate(
    seq = factor(taxa_names(ps)[v], levels = phylo_order),
    k = as.factor(k)
  ) %>%
  left_join(taxa) %>%
  mutate(
    family = fct_lump(Family, 7)
  )

ggplot(beta_hat) +
  geom_hline(intercept = 0, alpha = 0.5) +
  geom_boxplot(
    aes(x = seq, y = beta, fill = family, col = family),
    outlier.size = 0.2
  ) +
  facet_grid(k ~ .) +
  ylim(c(-5.8, 10)) +
  labs(y = "clog(p)") +
  theme(
    axis.text.x = element_blank(),
    legend.position = "bottom"
  )
```
